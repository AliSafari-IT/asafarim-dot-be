name: Testora CI

on:
  push:
    branches:
      - main-test
      - develop

jobs:
  run-tests:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Build Backend
        run: |
          dotnet build ASafariM.sln --configuration Release

      - name: Build Test Runner
        working-directory: apis/TestRunner
        run: |
          pnpm --filter test-automation-runner install
          pnpm --filter test-automation-runner build

      - name: Start Backend API
        run: |
          dotnet run --project apis/TestAutomation.Api/TestAutomation.Api.csproj --urls http://localhost:5106 &
        shell: pwsh

      - name: Wait for API
        run: |
          $retries = 0; do { try { Invoke-RestMethod http://localhost:5106/swagger/v1/swagger.json; $ok=$true } catch { Start-Sleep -Seconds 3; $retries++ } } while (-not $ok -and $retries -lt 20)
        shell: pwsh

      - name: Run Tests via Runner
        env:
          API_URL: http://localhost:5106
          API_KEY: ${{ secrets.TEST_RUNNER_API_KEY }}
          API_TOKEN: ${{ secrets.CI_JWT }}
        working-directory: apis/TestRunner
        run: |
          node dist/index.js &
          Start-Sleep -Seconds 2
          curl -X POST http://localhost:4000/run-tests -H "Content-Type: application/json" -H "x-api-key: $env:API_KEY" -d '{"runId": "ci-run", "runName": "CI Run", "environment": "CI", "browser": "chrome", "apiUrl": "http://localhost:5106", "userId": "ci"}'
        shell: pwsh

      - name: Archive Results
        if: always()
        run: |
          mkdir artifacts
          Get-ChildItem -Recurse -Filter *.json | Copy-Item -Destination artifacts -Force
        shell: pwsh

      - name: Upload Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: artifacts